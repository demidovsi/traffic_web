<!DOCTYPE html>
{% if lang == 'iw' %}
    <html lang="he">
{% else %}
    <html lang="{{lang}}">
{% endif %}
<head>
    
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

        <script>
            L_NO_TOUCH = false;
            L_DISABLE_3D = false;
        </script>
    
    <style>html, body {width: 100%;height: 100%;margin: 0;padding: 0;}</style>
    <style>#map {position:absolute;top:0;bottom:0;right:0;left:0;}</style>
    <style>
        @keyframes blink {
            0% { opacity: 1; }
            10% { opacity: 0; }
            100% { opacity: 1; }
        }

        .blinking-button {
            animation: blink 1s infinite;
        }
    </style>
    <style>
        .loading-icon {
            display: none;
            position: fixed;
            top: 25%;
            left: 25%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: #000;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!--{% if lang == 'iw' %}-->
<!--    <style>-->
<!--        body {-->
<!--            direction: rtl;-->
<!--            text-align: right;-->
<!--        }-->
<!--    </style>-->
<!--{% endif %}-->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.css">
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
          integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
          crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
          integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
          crossorigin="anonymous"></script>

    <link rel="stylesheet" type="text/css" href="/static/css/road.css">
    <link rel="shortcut icon" href="/static/motorway.png" >

            <meta name="viewport" content="width=device-width,
                initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
            <style>
                .leaflet-container { font-size: 1rem; }
            </style>
        
</head>
<body style="background: {{colors['background']}}; color: {{colors['black']}};">
<form method="post" name="{{own}}">
      {% include "include/select_language.html" %}
    <div id="loadingIcon" class="loading-icon"><img src="/static/waiting.png" width="128" height="128"></div>
    <input type="hidden" id="scroll" name="scroll" value="{{par['scroll']}}">
      <basefont size="6">
      <div class="menu">
          {% include "include/menu2.html" %}
      </div> <!-- menu -->
      <div class="container-flash">
            <!-- вывести все ошибки анализа ввода -->
          {% for message in get_flashed_messages(with_categories=True) %}
          <div class="alert alert-{{ message[0] }}">
              <button type="button" class="close" data-dismiss="alert">&times;</button>
              {{ message[1] }}
          </div>
          {% endfor %}
      </div> <!-- container-flash -->
      <div class="points">
        <p>
            <input type="hidden" id="need_route" name="need_route" value="{{par['need_route']}}">
            <button name="calculate" class="blinking-button" id="button_need_route"
                    style="background: {{colors['lightgray']}}; color: {{colors['red']}}"
                    title="Calculate route (was changes)">
                {{txt[2]}}
            </button>
            <button name="need_route" class="simple-text" id="button_not_need_route"
                    style="background: {{colors['background']}}; color: {{colors['red']}}"
                    title="Calculate route again">
                <u>{{txt[par['first_calc']]}}</u>
            </button>
            <select name="select_vid" id="select_vid" title="{{txt[21]}}"
                    style="background: {{colors['background']}}; color: {{colors['color_combobox']}};">
                {% for type in par['types'] %}
                    {% if type == par['select_type'] %}
                        <option value="{{type}}" selected>{{type}}</option>
                    {% else %}
                        <option value="{{type}}">{{type}}</option>
                    {% endif %}
                {% endfor %}
            </select>

            <span style="colors: {{colors['blue']}}">{{txt[0]}}:</span>
            <input id="start_point_init" value="{{par['start_point_init']}}" hidden>
            <input name="start_point" class="search" type="search" id="start_point" title="{{txt[22]}}"
                   style="background: {{colors['background']}}; color: {{colors['black']}}" value="{{par['start_point']}}"
                   placeholder="Input start point">
            <span style="colors: {{colors['blue']}}">{{txt[1]}}:</span>
            <input id="end_point_init" value="{{par['end_point_init']}}" hidden>
            <input name="end_point" class="search" type="search" id="end_point"  title="{{txt[23]}}"
                   style="background: {{colors['background']}}; color: {{colors['black']}}" value="{{par['end_point']}}"
                   placeholder="Input end point">
            <span style="color: {{colors['blue']}};">{{txt[3]}}:</span>
            <input type="datetime-local" id="dt_start_init" value="{{par['dt_start_init']}}" hidden>
            <input type="datetime-local" name="dt_start" value="{{par['dt_start']}}" required id="dt_start"
                   title="{{txt[24]}}"
                   style="background: {{colors['background']}}; color: {{colors['black']}};">
            {% if par['with_accidents'] %}
                <input type="checkbox" class="checkbox" name="with_accidents" checked>{{txt[14]}}
            {% else %}
                <input type="checkbox" class="checkbox" name="with_accidents">{{txt[14]}}
            {% endif %}
        </p>
          <p>
              {{txt[25]}}:
                <input value="{{par['select_preference_init']}}" id="select_preference_init" hidden>
                <select name="select_preference" id="select_preference" title="{{txt[26]}}"
                        style="background: {{colors['background']}}; color: {{colors['color_combobox']}};">
                    {% for data in par['preferences'] %}
                        {% if data['id'] == par['select_preference'] %}
                            <option value="{{data['id']}}" selected>{{data['name']}}</option>
                        {% else %}
                            <option value="{{data['id']}}">{{data['name']}}</option>
                        {% endif %}
                    {% endfor %}
                </select>
              {{txt[27]}} =
              <input type="number" value="{{par['count_routes_init']}}" id="count_routes_init" hidden>
              <input type="number" max="3" min="1" name="count_routes" value="{{par['count_routes']}}"
                     id="count_routes" title="{{txt[28]}}"
                     style="background: {{colors['background']}}; color: {{colors['black']}};">

              <input type="number" value="{{par['select_route_init']}}" hidden id="select_route_init">
              <label class="select_route" style="color: {{par['select_route_color']}};">
                  {{txt[29]}}=
              </label>
                 <input type="number" max="{{par['count_routes']}}" min="1" name="select_route" id="select_route"
                        value="{{par['select_route']}}" class="select_route_value"
                        title="{{txt[30]}}"
                        style="background: {{colors['background']}}; color: {{par['select_route_color']}};">
          </p>
        <p>
            {% if par['dist'] %}
                <span style="color: {{colors['blue']}}"> {{txt[4]}}=</span> {{par['dist']}}
            {% endif %}
            {% if par['time'] %}
                <span style="color: {{colors['blue']}}">{{txt[5]}}=</span> {{par['time']}}
            {% endif %}
            {% if par['weight'] %}
                <span style="color: {{colors['blue']}}">{{txt[6]}}=</span>{{par['weight']}}
            {% endif %}
            {% if par['coefficient'] %}
            <span style="color: {{colors['blue']}}">&nbsp&nbsp&nbsp&nbsp{{txt[9]}}=</span>
            <span style="color: {{colors['red']}}; font-size: 18px;">{{par['coefficient']}}</span>
            {% endif %}
            {% if par['max_weight'] %}
                <span style="color: {{colors['blue']}}">&nbsp&nbsp&nbsp&nbsp(max=</span>{{par['max_weight']}}
            {% endif %}
            {% if par['min_weight'] %}
                <span style="color: {{colors['blue']}}">min=</span>{{par['min_weight']}}
            {% endif %}
            {% if par['av_weight'] %}
                <span style="color: {{colors['blue']}}">av=</span>{{par['av_weight']}})
            {% endif %}
        </p>
      </div> <!-- points -->
      {% if par['select_type'] == 'Riskmeter' and par['coefficient'] %}
            <div class="data-chart">
                <div align="center" style="font-size: 22px">Riskmeter</div>
                <canvas id="riskChart"></canvas>
                <div class="result_risk" align="center" style="font-size: 22px">{{txt[13]}} =  {{txt[par['result_risk']]}}</div>
            </div> <!-- data-chart -->
      {% elif 'Chart' in par['select_type'] %}
            <div class="data-weight">
                <div align="center"> {{txt[15]}}</div>
                <canvas id="Chart_weight"></canvas>
            </div> <!-- data-weight -->
     {% elif par['select_type'] == 'Table' %}
            <div class="data">
                <table id="newsTable" class="table table-sm">
                    <thead  align="center" style="background: {{colors['lightgray']}}; color: {{colors['black']}};">
                        <tr>
                            <th id="th_number" scope="col" title="Номер отрезка">#</th>
                            <th id="th_time" scope="col" title="Time">Time</th>
                            <th id="th_weight" scope="col" title="Total weight of the waypoint">weight</th>
                            <th id="th_length" scope="col" title="Length of the segment">L</th>
                            <th id="th_way" scope="col" title="Length of the route from the start">way</th>
                            <th id="th_district" scope="col" title="Region name">district</th>
                            <th id="th_district_weight" scope="col" title="district weight">district weight</th>
                            <th id="th_speed" scope="col" title="Speed">speed</th>
                            <th id="th_speed_limit" scope="col" title="Speed limit">speed limit</th>
                            <th id="th_speed_limit_weight" scope="col" title="speed limit weight">speed weight</th>
    <!--                        <th id="th_road_type_weight" scope="col" title="road_type_weight">road type weight</th>-->
                            <th id="th_weather_condition" scope="col" title="weather condition">weather</th>
                            <th id="th_weather_condition_weight" scope="col" title="weather condition weight">weather weight</th>
                            <th id="th_road_condition" scope="col" title="road_condition">road condition</th>
                            <th id="th_road_condition_weight" scope="col" title="road condition">road weight</th>
                            <th id="th_day_night" scope="col" title="day_night">day night</th>
                            <th id="th_day_night_weight" scope="col" title="day nightweight">day night weight</th>
                            <th id="th_lighting_weight" scope="col" title="lighting_weight">lighting weight</th>
                            <th id="th_day_of_week" scope="col" title="day_of_week">day of week</th>
                            <th id="th_day_of_week_weight" scope="col" title="day_of_week_weight">day of week weight</th>
                            <th id="th_x" scope="col" title="Latitude">y</th>
                            <th id="th_y" scope="col" title="Longitude">x</th>
                            <th id="th_severity" scope="col" title="severity">S</th>
                            <th id="th_count_accident" scope="col" title="count accidents">cnt acd</th>
                            <th id="th_count_big_accident" scope="col" title="count big accidents">cnt big acd</th>
                            <th id="th_count_own_accident" scope="col" title="count own accidents">cnt own acd</th>
                        </tr>
                    </thead>
                    <tfoot>
                    </tfoot>
                    <tbody>
                        {% for data in par['data'] %}
                            {% if data['show'] %}
                                {% if data['count_own_accident'] and data['count_big_accident'] %}
                                    <tr style="color: {{colors['red']}};">
                                {% elif data['count_own_accident'] %}
                                    <tr style="color: {{colors['blue']}};">
                                {% else %}
                                    <tr style="color: {{colors['black']}};">
                                {% endif %}
                                    <td><div align="right">{{data['number']}}</div></td>
                                    <td><div align="right">{{data['dt_show']}}</div> </td>
                                    <td>
                                        <div align="right">{{data['weight_0']}}</div>
                                    </td>
                                    <td>
                                        <div align="right">{{data['length']}}</div>
                                    </td>
                                    <td>
                                        <div align="right">{{data['way']}}</div>
                                    </td>
                                    <td>{{data['district_name_eng']}}</td>
                                    <td><div align="right">{{data['district_weight']}}</div></td>
                                    <td>
                                        <div align="right">
                                            {{data['speed']}}
                                        </div>
                                    </td>
                                    <td>
                                        {% if data['speed_limit'] %}
                                            {{data['speed_limit']}}
                                        {% endif %}
                                    </td>
                                    <td>{{data['speed_limit_weight']}}</td>
                                    <td>
                                        {% if data['weather_condition'] %}
                                            {{data['weather_condition']}}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data['weather_condition_weight'] %}
                                            <div align="right">{{data['weather_condition_weight']}}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data['road_condition'] %}
                                            {{data['road_condition']}}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data['road_condition_weight'] %}
                                            <div align="right">{{data['road_condition_weight']}}</div>
                                        {% endif %}
                                    </td>
                                    <td>{{data['day_night']}}</td>
                                    <td><div align="right">{{data['day_night_weight']}}</div></td>
                                    <td>{{data['lighting_weight']}}</td>
                                    <td>{{data['day_of_week']}}</td>
                                    <td><div align="right">{{data['day_of_week_weight']}}</div></td>
                                    <td><div align="right">{{data['x']}}</div></td>
                                    <td><div align="right">{{data['y']}}</div></td>
                                    <td>
                                        {% if data['severity'] %}
                                            <div align="right">{{data['severity']}}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data['count_accident'] %}
                                            <div align="right">{{data['count_accident']}}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data['count_big_accident'] %}
                                            <div align="right">{{data['count_big_accident']}}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if data['count_own_accident'] %}
                                            <div align="right">{{data['count_own_accident']}}</div>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
            </div> <!-- data -->
     {% elif par['select_type'] == 'Accident not used' %}
                {% if par['count_not_used'] %}
                    <div align="center" style="color: {{colors['red']}}; background: {{colors['background']}}">
                        {{txt[16]}} = {{par['count_not_used']}}
                    </div>
                {% endif %}
            <div class="data">
                <table id="newsTable" class="table table-sm">
                    <thead  align="center" style="background: {{colors['lightgray']}}; color: {{colors['black']}};">
                        <tr>
                            <th id="th_district" scope="col" title="Region name">district</th>
                            <th id="th_district_weight" scope="col" title="district weight">district weight</th>
                            <th id="th_speed_limit" scope="col" title="Speed limit">speed limit</th>
                            <th id="th_speed_limit_weight" scope="col" title="speed limit weight">speed weight</th>
    <!--                        <th id="th_road_type_weight" scope="col" title="road_type_weight">road type weight</th>-->
                            <th id="th_weather_condition" scope="col" title="weather condition">weather</th>
                            <th id="th_weather_condition_weight" scope="col" title="weather condition weight">weather weight</th>
                            <th id="th_road_condition" scope="col" title="road_condition">road condition</th>
                            <th id="th_road_condition_weight" scope="col" title="road condition">road weight</th>
                            <th id="th_day_night" scope="col" title="day_night">day night</th>
                            <th id="th_day_night_weight" scope="col" title="day nightweight">day night weight</th>
                            <th id="th_lighting_weight" scope="col" title="lighting_weight">lighting weight</th>
                            <th id="th_day_of_week" scope="col" title="day_of_week">day of week</th>
                            <th id="th_day_of_week_weight" scope="col" title="day_of_week_weight">day of week weight</th>
                            <th id="th_x" scope="col" title="Latitude">y</th>
                            <th id="th_y" scope="col" title="Longitude">x</th>
                            <th id="th_severity" scope="col" title="severity">S</th>
                        </tr>
                    </thead>
                    <tfoot>
                    </tfoot>
                    <tbody>
                        {% for data in par['not_used'] %}
                            <tr style="color: {{colors['black']}};">
                                <td>{{data['district_name_eng']}}</td>
                                <td><div align="right">{{data['district_weight']}}</div></td>
                                <td>
                                    {% if data['speed_limit'] %}
                                        {{data['speed_limit']}}
                                    {% endif %}
                                </td>
                                <td>{{data['speed_limit_weight']}}</td>
                                <td>
                                    {% if data['weather_condition'] %}
                                        {{data['weather_condition']}}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if data['weather_condition_weight'] %}
                                        <div align="right">{{data['weather_condition_weight']}}</div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if data['road_condition'] %}
                                        {{data['road_condition']}}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if data['road_condition_weight'] %}
                                        <div align="right">{{data['road_condition_weight']}}</div>
                                    {% endif %}
                                </td>
                                <td>{{data['day_night']}}</td>
                                <td><div align="right">{{data['day_night_weight']}}</div></td>
                                <td>{{data['lighting_weight']}}</td>
                                <td>{{data['day_of_week_name']}}</td>
                                <td><div align="right">{{data['day_of_week_weight']}}</div></td>
                                <td><div align="right">{{data['longitude_str']}}</div></td>
                                <td><div align="right">{{data['latitude_str']}}</div></td>
                                <td>
                                    {% if data['severity'] %}
                                        <div align="right">{{data['severity']}}</div>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div> <!-- data -->
    {% endif %}
    <div class="switch">
        {% if par['select_type'] == 'Table' %}
            {% if par['switch'] == 'all_route' %}
                <button class="btn-menu-active" name="all_route"
                        style="background: {{colors['lightgray']}}; color: {{colors['green']}}">
                    <b>{{txt[7]}}</b>
                    {% if par['count']%}
                        ({{par['count']}})
                    {% endif %}
                </button>
                <button class="btn-menu" name="accidents"
                        style="background: {{colors['background']}}; color: {{colors['black']}}">
                    {{txt[8]}}
                    {% if par['count_accidents']%}
                        ({{par['count_accidents']}})
                    {% endif %}
                </button>
            {% else %}
                <button class="btn-menu" name="all_route"
                        style="background: {{colors['background']}}; color: {{colors['black']}}">
                    {{txt[7]}}
                    {% if par['count']%}
                        ({{par['count']}})
                    {% endif %}
                </button>
                <button class="btn-menu-active" name="accidents"
                        style="background: {{colors['lightgray']}}; color: {{colors['green']}}">
                    <b>{{txt[8]}}</b>
                    {% if par['count_accidents']%}
                        ({{par['count_accidents']}})
                    {% endif %}
                </button>
            {% endif %}
        {% endif %}
    </div> <! switch -->
    <div class="folium-map" id="map_f4ea2d590327241e553f226e8564c166" ></div>
</form>
</body>

{% if 'Chart' in par['select_type'] %}
<script src='/static/js/Chart.js'></script>
<script>
        var chartData_weight = {
            labels : [{% for item in par['value_x'] %}
                        "{{item}}",
                      {% endfor %}
                      ],
            datasets : [{
                label: [],
                fill: false,
                lineTension: 0.1,
                backgroundColor: ["#3e95cd"],
                borderColor: "rgba(75,192,192,1)",
                borderCapStyle: 'butt',
                borderDash: [],
                borderDashOffset: 0.0,
                borderJoinStyle: 'miter',
                pointBorderColor: "rgba(75,192,192,1)",
                pointBackgroundColor: "#fff",
                pointBorderWidth: 1,
                pointHoverRadius: 5,
                pointHoverBackgroundColor: "rgba(75,192,192,1)",
                pointHoverBorderColor: "rgba(220,220,220,1)",
                pointHoverBorderWidth: 2,
                pointRadius: 3,
                pointHitRadius: 10,
                data : [
                    {% for item in par['value_y'] %}
                        {{item}},
                    {% endfor %}
                        ],
                spanGaps: false
            }]
        }

    <!--    get chart canvas-->
        var ctx_weight = document.getElementById("Chart_weight").getContext("2d");
        var options_weight =
        {
            scales: {
                x: {
                    ticks: { fontColor: '{{colors['black']}}'},
                    {% if upr['theme'] != 'white' %}
                        gridLines: { color: '{{colors['lightgray']}}'}
                    {% endif %}
                },
                y: {
                    beginAtZero: false,
                    ticks: { fontColor: '{{colors['black']}}'},
                    {% if upr['theme'] != 'white' %}
                        gridLines: { color: '{{colors['lightgray']}}'}
                    {% endif %}
                }

            },
            legend:{
                display: false
            }
        };

    <!--    create the chart using the chart canvas-->
        var Chart_weight = new Chart(
            ctx_weight, {
                    responsive: false,
                    type: 'line',
                    data: chartData_weight,
                    options: options_weight,
                 }
            );
    </script>
{% endif %}

{% if par['select_type'] == 'Riskmeter' and par['coefficient'] %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var oilCanvas = document.getElementById("riskChart");

        var oilData = {
            labels: [
                "{{txt[10]}}", "{{txt[11]}}", "{{txt[12]}}", "{{txt[13]}}"
                ],
            datasets: [
                {
                    label: "Riskmeter",
                    data: [{{par['value_green']}}, {{par['value_yellow']}}, {{par['value_red']}}, 0],
                    backgroundColor: [
                        "lightgreen",
                        "yellow",
                        "red",
                        "blue"
                    ],
                    borderColor: "black",
                    borderWidth: 0
                },
                {
                    data: [{{par['coefficient']}}, {{par['empty_coefficient']}}],
                    backgroundColor: [
                        "blue",
                        "{{colors['background']}}",
                    ],
                    borderColor: "{{colors['background']}}",
                    borderWidth: 0
                }
                ]
        };

        var chartOptions = {
          rotation: -90,
          cutoutPercentage: 0,
          circumference: 180,
          legend: {
            position: 'left'
          },
          animation: {
            animateRotate: true,
            animateScale: true
          },
          plugins: {
            legend: {
                labels: {color: "{{colors['black']}}"}
            }
          }
        };
        var pieChart = new Chart(oilCanvas, {
          type: 'doughnut',
          data: oilData,
          options: chartOptions
        });
    </script>
{% endif %}

{% if par['locations'] %}
    <script>
        <!-- определение центральной точки на графике -->
        var map_f4ea2d590327241e553f226e8564c166 = L.map(
            "map_f4ea2d590327241e553f226e8564c166",
            {
                {% if par['start_x'] %}
                    center: [{{(par['start_x'] + par['end_x'])/2}}, {{(par['start_y'] + par['end_y'])/2}}],
                {% else %}
                    center: [],
                {% endif %}
                crs: L.CRS.EPSG3857,
                ...{
                      "zoom": {{par['zoom']}},
                      "zoomControl": true,
                      "preferCanvas": false,
                    }
            }
        );
        var tile_layer_cae6cde8fbfcd30c800e14e41ae66e07 = L.tileLayer(
            "https://tile.openstreetmap.org/{z}/{x}/{y}.png",
            {
                "minZoom": 0,
                "maxZoom": 19,
                "maxNativeZoom": 19,
                "noWrap": false,
                "attribution": "\u0026copy; \u003ca href=\"https://www.openstreetmap.org/copyright\"\u003eOpenStreetMap\u003c/a\u003e contributors",
                "subdomains": "abc",
                "detectRetina": false,
                "tms": false,
                "opacity": 1,
            }
        );
        tile_layer_cae6cde8fbfcd30c800e14e41ae66e07.addTo(map_f4ea2d590327241e553f226e8564c166);

        <!-- добавить на карту начальную точку -->
        var marker_3d8e5a1c6fa863b6ff1c72a1c0c2d666 = L.marker(
                {% if par['start_x'] %}
                    [{{par['start_x']}}, {{par['start_y']}}],
                {% else %}
                    [],
                {% endif %}
        ).addTo(map_f4ea2d590327241e553f226e8564c166);

        <!-- иконка начальной точки -->
        var icon_84b8e3f1ca8851251ae5743c020b4785 = L.AwesomeMarkers.icon(
            {
                "markerColor": "green",
                "iconColor": "white",
                "icon": "home",
                "prefix": "glyphicon",
                "extraClasses": "fa-rotate-0",
            }
        );
        marker_3d8e5a1c6fa863b6ff1c72a1c0c2d666.setIcon(icon_84b8e3f1ca8851251ae5743c020b4785);
        <!-- tooltip начальной точки -->
        marker_3d8e5a1c6fa863b6ff1c72a1c0c2d666.bindTooltip(
            `<div> {{par['start_point']}} {{par['start_xy']}} </div>`,
            { "sticky": true, }
        );

    <!-- добавить на карту точки аварий -->
        <!-- иконка аварий -->
        var icon_accident = L.AwesomeMarkers.icon(
            {
                "markerColor": "blue",
                "icon": "car",
                "extraClasses": "fa-class",
            }
        );
        <!-- иконка крупных аварий -->
        var icon_big_accident = L.AwesomeMarkers.icon(
            {
                "markerColor": "yellow",
                "icon": "car",
                "extraClasses": "fa-class",
            }
        );

        {% for data in par['data'] %}
            {% if data['is_accident'] %}
                {% if 'big_accident_in_point' in data %}
                    L.marker([{{data['x']}}, {{data['y']}}]).addTo(map_f4ea2d590327241e553f226e8564c166).
                    setIcon(icon_big_accident).bindTooltip(`<div>
                        {{data['tooltip_accident']}}
                        </div>`,
                            { "sticky": true, });
                {% else %}
                    L.marker([{{data['x']}}, {{data['y']}}]).addTo(map_f4ea2d590327241e553f226e8564c166).
                    setIcon(icon_accident).bindTooltip(`<div>
                        {{data['tooltip_accident']}}
                        </div>`,
                            { "sticky": true, });
                {% endif %}
            {% endif %}
        {% endfor %}

        <!-- добавить на карту конечную точку -->
        var marker_d547c9fda8e0eadf27523382b3fba29e = L.marker(
                {% if par['end_x'] %}
                    [{{par['end_x']}}, {{par['end_y']}}],
                {% else %}
                    [],
                {% endif %}
            {
            }
        ).addTo(map_f4ea2d590327241e553f226e8564c166);
        var icon_5ceb0f7235a77422e8861bc11480230c = L.AwesomeMarkers.icon(
            {
                "markerColor": "red",
                "iconColor": "white",
                "icon": "home",
                "prefix": "glyphicon",
                "extraClasses": "fa-rotate-0",
            }
        );
        marker_d547c9fda8e0eadf27523382b3fba29e.setIcon(icon_5ceb0f7235a77422e8861bc11480230c);
        <!-- tooltip конечной точки -->
        marker_d547c9fda8e0eadf27523382b3fba29e.bindTooltip(
            `<div> {{par['end_point']}} {{par['end_xy']}} </div>`,
            { "sticky": true, }
        );

        <!-- добавить на карту линии маршрута -->
        {% for data in par['locations'] %}
            var poly_line_e8b1b906de671f211ee84b282ba5bd9d = L.polyline(
                    {{data['locations']}},
                    {"bubblingMouseEvents": true, "color": "{{data['color']}}", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "{{data['color']}}",
                    "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8,
                    "smoothFactor": 1.0, "stroke": true, "weight": 5}
            ).addTo(map_f4ea2d590327241e553f226e8564c166);
        {% endfor %}
        $('body').show();
    </script>
{% endif %}

<script>
    var need_route = document.querySelector('#need_route');
    var button_need_route = document.querySelector('#button_need_route');
    var button_not_need_route = document.querySelector('#button_not_need_route');
    var start_point = document.querySelector('#start_point');
    var start_point_init = document.querySelector('#start_point_init');
    var end_point = document.querySelector('#end_point');
    var end_point_init = document.querySelector('#end_point_init');
    var dt_start = document.querySelector('#dt_start');
    var dt_start_init = document.querySelector('#dt_start_init');
    var count_routes = document.querySelector('#count_routes');
    var count_routes_init = document.querySelector('#count_routes_init');
    var class_select_route = document.querySelector('.select_route');
    var class_select_route_value = document.querySelector('.select_route_value');
    var select_preference = document.querySelector('#select_preference');
    var select_preference_init = document.querySelector('#select_preference_init');
    const loadingIcon = document.getElementById('loadingIcon');

    var select_route = document.querySelector('#select_route');
    var select_route_init = document.querySelector('#select_route_init');

    {% if par['select_type'] == 'Table' %}
        const scroller = document.querySelector('.data');
        const scroll = document.querySelector("#scroll");
     {% endif %}
    $(function() {
        $(document).ready(function () {
            $('#select_vid').on('change', function() { document.forms['{{own}}'].submit(); });
            $('.checkbox').on('change', function() { document.forms['{{own}}'].submit(); });
            $('#select_language').on('change', function() { document.forms['{{own}}'].submit(); });
            $('#start_point').on('input', function() { calc_change(); });
            $('#end_point').on('input', function() { calc_change(); });
            $('#dt_start').on('input', function() { calc_change(); });
            $('#select_route').on('input', function() { document.forms['{{own}}'].submit();});
            $('#count_routes').on('input', function() { calc_change(); });
            $('#select_preference').on('input', function() { calc_change(); });

            $('#button_need_route').on('click', function() {
                button_need_route.style.visibility = 'hidden';
                button_need_route.classList.remove('blinking-button');
                need_route.value = '1';
                loadingIcon.style.display = 'block';
                document.body.style.backgroundColor = '#DCDCDC';
                document.body.style.color = 'black';
                document.forms['{{own}}'].submit();
                });

            $('#button_not_need_route').on('click', function() {
                button_not_need_route.style.visibility = 'hidden';
                need_route.value = '1';
                loadingIcon.style.display = 'block';
                document.body.style.backgroundColor = '#DCDCDC';
                document.body.style.color = 'black';
                document.forms['{{own}}'].submit();
                });

            function calc_change() {
                var count = 0;
                if (start_point && start_point_init && start_point.value.trim() !== '' &&
                    start_point.value.trim() !== start_point_init.value.trim()) { count += 1; }
                if (end_point && end_point_init && end_point.value.trim() !== '' &&
                    end_point.value.trim() !== end_point_init.value.trim()) { count += 1; }
                if (dt_start && dt_start_init && dt_start.value.trim() !== '' &&
                    dt_start.value.trim() !== dt_start_init.value.trim()) { count += 1; }
                if (select_route && select_route_init && select_route.value.trim() !== '' &&
                    select_route.value.trim() !== select_route_init.value.trim()) { count += 1; }
                if (count_routes && count_routes_init && count_routes.value.trim() !== '' &&
                    count_routes.value.trim() !== count_routes_init.value.trim()) { count += 1; }
                if (select_preference && select_preference_init &&
                    select_preference.value.trim() !== select_preference_init.value.trim()) { count += 1; }
                if (count_routes.value == '1')
                    {
                        class_select_route.style.visibility = 'hidden';
                        class_select_route_value.style.visibility = 'hidden';
                    } else
                    {
                        class_select_route.style.visibility = 'visible';
                        class_select_route_value.style.visibility = 'visible';
                    };
                if (count > 0)
                    { button_need_route.style.visibility = 'visible'; button_not_need_route.style.visibility = 'hidden'; }
                else
                    { button_need_route.style.visibility = 'hidden'; button_not_need_route.style.visibility = 'visible'; };
            };

        $(function () {
            calc_change();
            $('body').show();
            {% if par['select_type'] == 'Table' %}
                    scroller.scrollTop=scroll.value;
             {% endif %}
        }); // end ready
    });

    {% if par['select_type'] == 'Table' %}
    scroller.addEventListener("scroll", (event) => {
        scroll.value = scroller.scrollTop;
            });
    {% endif %}
});
</script>

<script>
   document.querySelector('form').addEventListener('keypress', function(event) {
if (event.key === 'Enter' && event.target.type !== 'textarea')     {
       // Стоп, отправка прерывается!
       event.preventDefault();
     }
   });
</script>

</html>